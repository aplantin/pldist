---
title: "Introduction to pldist"
author: "Anna Plantinga"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to pldist}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Outline  

- [Introduction] 
- [Overview]
- [Installation]
- [Usage Guide]
    + [Data Transformations] 
    + [UniFrac Family Distances] 
    + [All Distances] 
- [Transformations and Dissimilarities] 
    + [Transformations] 
    + [Bray-Curtis]
    + [Jaccard] 
    + [Kulczynski] 
    + [Gower] 
    + [Unweighted UniFrac] 
    + [Generalized UniFrac]
- [Appendix: Generating Test Data]
- [References] 

## Introduction

`pldist` is a package that allows distance-based analysis of paired and longitudinal microbiome data. In particular, the package supports both paired and longitudinal versions of unweighted UniFrac, generalized UniFrac, Bray-Curtis, Jaccard, Gower, and Kulczynski distances or dissimilarities. Functions implementing the transformations that underlie these distances are also provided so that transformed OTU data may be included in analyses beyond distance-based methods. The code can handle paired data, balanced longitudinal data, and unbalanced longitudinal data, although applying these methods in the context of highly unbalanced designs is not recommended. 

## Overview

The big picture of this set of methods is a two-step process in which (1) OTU data at multiple time points for a subject are summarized into the change across time for each OTU, and (2) these changes across time are compared between subjects. 

Four transformations are available to define changes within a subject. All are discussed in more detail in [Transformations and Dissimilarities]. The choices distinguishing these four transformations are **paired vs. longitudinal** and **qualitative vs. quantitative**. 

First, **paired vs. longitudinal**: 
- The paired transformations allow exactly two time points per subject (or pairs of subjects). They account for direction of change, so if a taxon becomes 20\% more abundant in one subject and 20\% less abundant in another subject, the difference in changes across time is 40\%. 
- The longitudinal transformations allow any number of time points per subject, including different numbers of observations or time between observations for different subjects. They do not account for direction of change, so if a taxon becomes 20\% more abundant in one subject and 20\% less abundant in another subject, those subjects experienced *the same* magnitude of change with respect to that taxon. 

Secondly, **qualitative vs. quantitative**: 
- For qualitative transformations, only changes in presence or absence of OTUs contribute to the distance or dissimilarity. A 20\% change in OTU abundance does not matter, whereas an OTU that was present at time 1 but not observed at time 2 does contribute to the distance. 
- For quantitative transformations, changes in OTU abundance do matter. If an OTU changes by 20\% in relative abundance for one subject and 40\% for another subject, those are considered different changes (and contribute to the overall dissimilarity between those two subjects). 

Once the selected data transformation has been applied, a corresponding version of the Bray-Curtis, Jaccard, Kulczynski, Gower, or UniFrac distance metrics may be calculated between subjects. The resulting distance matrices may be used in any distance-based analysis, including ordination analysis, kernel machine regression methods, permutation-based testing, and others. 

The author and maintainer of the `pldist` R package is Anna Plantinga. 

## Installation 

Currently, the package may only be downloaded and installed from GitHub using the `devtools` package. Type the following command in your R console: 

```{r installation-instructions}
# only run if you don't have devtools installed 
#install.packages("devtools"); library(devtools) 
devtools::install_github("aplantin/pldist")
``` 

## Usage Guide

This section provides an overview of the main components of the package and usage basics. We will briefly outline the main functions, see examples of function usage, and examine the output. 

First, we load the `pldist` package. 

```{r load} 
library(pldist)
``` 

The primary function in this package calculates distance (or dissimilarity) matrices for all subjects in a dataset. Users can specify paired versus longitudinal, qualitative versus quantitative analysis, and the desired distance metric via function arguments. 

We demonstrate function behavior using simulated data. The code to generate this data is included in the Appendix. 

```{r load-data}
data("sim.tree")
data("paired.otus"); data("paired.meta")
data("bal.long.otus"); data("bal.long.meta")
data("unbal.long.otus"); data("unbal.long.meta")
```

### Data Transformations 

The data transformation function is `pltransform`. The transformations are provided as a separate function so that if desired, paired or longitudinally transformed data may be included in other (distance-based or non-distance-based) analyses. This function **does not** need to be called prior to utilizing the distance function; all transformations (and input checking) are included within the distance function. 

Required function input consists of: 

- An OTU matrix with one row per sample and one column per OTU; row names should be unique sample identifiers 
- Sample metadata, consisting of: 
    + Subject identifiers, with column name "subjID". 
    + Sample identifiers, with column name "sampID". These must exactly match the row names of the OTU matrix. 
    + An indicator of time or group, with column name "time". For paired data, this may take any two unique values. For longitudinal data, as.numeric() must give the proper levels with proper spacing; in the vast majority of cases, this column should be a numerical variable indicating time.
- Logical indicating whether the data are paired 
- Logical indicating whether to check function input before proceeding (default TRUE). This should always be TRUE unless the function is being called from within another function and the data checks have already occurred. 
    
The output consists of a list with components: 

- dat.binary: transformed data matrix after using qualitative/binary transformation (as described in the later section [Transformations and Dissimilarities]) 
- dat.quant: transformed data matrix after using quantitative transformation (again, as described later) 
- avg.prop: average proportion of each OTU for each subject
- Type of transformations used (paired vs. longitudinal), accessible by res$type.  

```{r transform} 
# Input: Notice that row names are sample IDs 
paired.otus[1:4,1:4]
paired.meta[1:4,]

# Transformation function 
res <- pltransform(paired.otus, paired.meta, paired = TRUE, check.input = TRUE)

# Binary transformation 
# 0.5 indicates OTU was present at Time 2, absent at Time 1
# -0.5 indicates OTU was present at Time 1, absent at Time 2 
# Row names are now subject IDs 
res$dat.binary   

# Quantitative transformation (see details in later sections)
round(res$dat.quant, 2)

# Average proportion per OTU per subject 
round(res$avg.prop, 2)

# This was a paired transformation 
res$type 

# For comparison, this uses a longitudinal transformation (applied at 2 time points)
# due to the argument "paired = FALSE". 
# Type is "Balanced" because same time points were observed for all subjects 
res2 <- pltransform(paired.otus, paired.meta, paired = FALSE, check.input = TRUE)
res2$type   

# With the longitudinal binary transformation applied at 2 time points, the value 
# is 1 if any change in presence/absence was observed, 0 otherwise 
res2$dat.binary 

# And if you use an unbalanced design, the function gives a warning. 
# It otherwise operates in the same way. 
res3 <- pltransform(unbal.long.otus, unbal.long.meta, paired = FALSE, check.input = TRUE)
round(res3$dat.quant[1:4,1:4], 2)
``` 
